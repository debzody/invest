<!DOCTYPE html>
<html>
<head>
    <title>Investment Tracker</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Investment Tracker</h1>
        <div class="total-section">
            <h2>Total Value: <span id="totalValue">₹0.00</span></h2>
            <button id="refreshPrices">Refresh Prices</button>
            <span id="refreshStatus"></span>
        </div>
        
        <!-- Add Investment Form -->
        <div class="form-section">
            <h2>Add New Investment</h2>
            <form id="investmentForm">
                <select name="type" required>
                    <option value="stock">Stock</option>
                    <option value="mutual_fund">Mutual Fund</option>
                </select>
                <select name="suggestion" id="suggestionBox" onchange="fillFields()">
                    <option value="">Select a suggestion</option>
                    <option value="SAP|SAP SE|XETR">SAP SE (XETR)</option>
                    <option value="HONASA.NS|HONASA Consumer Ltd.|NSE">HONASA Consumer Ltd. (NSE)</option>
                    <option value="HDFCLIFE|HDFC Life Insurance|NSE">HDFCLIFE (NSE)</option>
                    <option value="JIOFIN|Jio Financial Services|NSE">JIOFIN (NSE)</option>
                    <option value="NTPCGREEN|NTPC Green Energy|NSE">NTPCGREEN (NSE)</option>
                    <option value="TATATECH|Tata Technologies|NSE">TATATECH (NSE)</option>
                    <option value="HDFC_TECH|HDFC Technology Fund|MF">HDFC Technology Fund (MF)</option>
                    <option value="INVESCO_TECH|Invesco India Technology Fund|MF">Invesco India Technology Fund (MF)</option>
                    <option value="MO_SMALLCAP|Motilal Oswal Small Cap Fund|MF">Motilal Oswal Small Cap Fund (MF)</option>
                    <option value="MO_MULTICAP|Motilal Oswal Multi Cap Fund|MF">Motilal Oswal Multi Cap Fund (MF)</option>
                    <option value="MO_DEFENCE|Motilal Oswal Nifty India Defence Index Fund|MF">Motilal Oswal Nifty India Defence Index Fund (MF)</option>
                    <option value="EDEL_TECH|Edelweiss Technology Fund|MF">Edelweiss Technology Fund (MF)</option>
                </select>
                <input type="text" name="symbol" id="symbol" placeholder="Symbol" required>
                <input type="text" name="name" id="name" placeholder="Name" required>
                <input type="number" name="quantity" placeholder="Quantity" step="0.01" required>
                <input type="number" name="purchase_price" placeholder="Purchase Price" step="0.01" required>
                <button type="submit">Add Investment</button>
            </form>
        </div>

        <!-- Investments Table -->
        <div class="table-section">
            <h2>Your Investments</h2>
            <table id="investmentsTable">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Symbol</th>
                        <th>Name</th>
                        <th>Quantity</th>
                        <th>Purchase Price</th>
                        <th>Current Price</th>
                        <th>Total Value</th>
                        <th>Profit/Loss</th>
                        <th>Date Added</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="investmentsBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        function fillFields() {
            const suggestion = document.getElementById('suggestionBox').value;
            if (suggestion) {
                const [symbol, name] = suggestion.split('|');
                document.getElementById('symbol').value = symbol;
                document.getElementById('name').value = name;
            }
        }

        document.getElementById('investmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/add_investment', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.reset();
                    updateTable();
                }
            });
        });

        function updateTable() {
            fetch('/get_investments')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('investmentsBody');
                tbody.innerHTML = '';
                data.investments.forEach((inv, index) => {
                    const totalValue = inv.quantity * inv.current_price;
                    const profitLoss = totalValue - (inv.quantity * inv.purchase_price);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${inv.type}</td>
                        <td>${inv.symbol}</td>
                        <td>${inv.name}</td>
                        <td><input type="number" class="edit-quantity" value="${inv.quantity.toFixed(2)}" step="0.01" data-index="${index}"></td>
                        <td><input type="number" class="edit-price" value="${inv.purchase_price.toFixed(2)}" step="0.01" data-index="${index}">${inv.currency}</td>
                        <td>
                            ${inv.type === 'mutual_fund' ? 
                                `<input type="number" class="edit-current-price" value="${inv.current_price.toFixed(2)}" step="0.01" data-index="${index}">${inv.currency}` :
                                `${inv.currency}${inv.current_price.toFixed(2)}`}
                        </td>
                        <td>${inv.currency}${totalValue.toFixed(2)}</td>
                        <td class="${profitLoss >= 0 ? 'profit' : 'loss'}">${inv.currency}${profitLoss.toFixed(2)}</td>
                        <td>${inv.date_added}</td>
                        <td>
                            <button class="save-btn" data-index="${index}">Save</button>
                            <button class="delete-btn" data-index="${index}">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('totalValue').textContent = `₹${data.total_inr.toFixed(2)}`;

                document.querySelectorAll('.save-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        const quantity = document.querySelector(`.edit-quantity[data-index="${index}"]`).value;
                        const purchase_price = document.querySelector(`.edit-price[data-index="${index}"]`).value;
                        const current_price = document.querySelector(`.edit-current-price[data-index="${index}"]`)?.value || null;
                        fetch('/update_investment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ index, quantity, purchase_price, current_price })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') updateTable();
                        });
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        fetch('/delete_investment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ index })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') updateTable();
                        });
                    });
                });
            });
        }

        function updatePrices() {
            document.getElementById('refreshStatus').textContent = 'Updating...';
            fetch('/update_prices')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('refreshStatus').textContent = data.status;
                    updateTable();
                });
        }

        document.getElementById('refreshPrices').addEventListener('click', updatePrices);
        setInterval(updatePrices, 30000); // Update stocks every 30 seconds
        setInterval(updateTable, 5000);   // Refresh table every 5 seconds
        updateTable();
    </script>
</body>
</html>